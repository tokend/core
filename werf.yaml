configVersion: 1
project: 'core'
---
image: core              # Название собираемого образа.
from: registry.gitlab.com/tokend/devops/docker-containers:core-latest               # Базовый образ.
docker:
  WORKDIR: /
git:                        # Секция с директивами для добавления исходных файлов из git-репозитория.
- add: /                    # Исходный путь в репозитории.
  to: /                  # Путь назначения в образе.
  stageDependencies:        # Настройка перевыполнения сборочных инструкций при изменениях определённых файлов в репозитории.
    setup:                  # Для стадии Setup.
    - "**/*"
shell:                      # Shell сборочные инструкции.
  setup:                    # Для стадии Setup.
  - export CORE_REVISION={{ env "CI_COMMIT_SHA" }}
  - cmake CMakeLists.txt -DPostgreSQL_INCLUDE_DIRS=/usr/include/postgresql/ -DPostgreSQL_LIBRARIES=/usr/lib/x86_64-linux-gnu/libpq.so
  - make -j4

---
image: corenc
from: registry.gitlab.com/tokend/devops/docker-containers:core-latest
docker:
  WORKDIR: /build
git:                        # Секция с директивами для добавления исходных файлов из git-репозитория.
- add: /                    # Исходный путь в репозитории.
  to: /                  # Путь назначения в образе.
  stageDependencies:        # Настройка перевыполнения сборочных инструкций при изменениях определённых файлов в репозитории.
    setup:                  # Для стадии Setup.
    - "*"
shell:                      # Shell сборочные инструкции.
  setup:                    # Для стадии Setup.
  - export CORE_REVISION={{ env "CI_COMMIT_SHA" }}
  - cmake CMakeLists.txt -DPostgreSQL_INCLUDE_DIRS=/usr/include/postgresql/ -DPostgreSQL_LIBRARIES=/usr/lib/x86_64-linux-gnu/libpq.so -DDISABLE_CONSESUS=1
  - make -j4
